<!DOCTYPE html
PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>FatRat web interface</title>
<link rel="icon" href="/favicon.png" type="image/png"/>
<link rel="stylesheet" type="text/css" href="/style.css"/>
<script type="text/javascript" src="/index.js"></script>
</head>

<body onload="javascript: loadRefresh();">
<p><img src="logo.png" alt="FatRat logo"/></p>

<?
if(GET.queue == undefined && QUEUES.length != 0)
	GET.queue = 0;
function escapeAmpersand(text)
{
	text = new String(text);
	return text.split('&').join('&amp;');
}
?>

<form method="get" action="">
<p class="toolbar">
	Queue: <select name="queue" onchange="javascript:this.form.submit()">
	<?
		for(i=0;i<QUEUES.length;i++)
		{
			print('<option value="'+i+'" ');
			if(GET.queue == i)
				print('selected="selected"');
			print('>'+QUEUES[i].name+'</option>');
		}
	?>
	</select>
	<input type="submit" id="sumbit_queue" value="Switch"/>
	<script type="text/javascript"><!--
	document.getElementById('sumbit_queue').setAttribute('style', 'visibility: hidden');
	document.write('');
	--></script>
</p>
</form>

<form method="post" id="mainform" action="?<? print(escapeAmpersand(QUERY_STRING)); ?>">

<noscript>
	<p><a href="/add_transfer.qsp?queue=<? print(GET.queue); ?>">Add transfer</a></p>
</noscript>
<p class="toolbar">
	<span class="ralign" title="Will not reload if any checkboxes are checked">
		Reload every
		<select id="refresh" onchange="javascript:refreshChange()">
			<option value="0">never</option>
			<option value="5">5 seconds</option>
			<option value="10">10 seconds</option>
			<option value="30">30 seconds</option>
			<option value="60">minute</option>
		</select>
	</span>
	
	<script type="text/javascript"><!--
		document.write('<button type="button" onclick="javascript:newwin(\'/add_transfer.qsp?queue=<? print(GET.queue); ?>\')" title="New transfer"><img src="/add.png" alt="New transfer"/></button>');
		document.write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;');
	//--></script>
	
	<button type="submit" name="remove" value="delete" title="Delete" onclick="javascript:return confirm('Do you really want to delete the selected transfers?')"><img src="/delete.png" alt="Delete"/></button>
	<button type="submit" name="remove" value="delete_data" title="Delete including data" onclick="javascript:return confirm('Do you really want to delete the selected transfers and their data?')"><img src="/delete_with_data.png" alt="Delete including data"/></button>
	<button type="submit" name="cleanup" value="cleanup" title="Remove completed"><img src="/states/completed.png" alt="Remove completed"/></button>
	<button type="submit" name="setState" value="Active" title="Resume"><img src="/states/active.png" alt="Resume"/></button>
	<button type="submit" name="setState" value="ForcedActive" title="Force resume"><img src="/states/forcedactive.png" alt="Force resume"/></button>
	<button type="submit" name="setState" value="Paused" title="Pause"><img src="/states/paused.png" alt="Pause"/></button>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<button type="submit" name="move" value="top" title="Move to the top"><img src="/move/top.png" alt="Move to the top"/></button>
	<button type="submit" name="move" value="up" title="Move up"><img src="/move/up.png" alt="Move up"/></button>
	<button type="submit" name="move" value="down" title="Move down"><img src="/move/down.png" alt="Move down"/></button>
	<button type="submit" name="move" value="bottom" title="Move to the bottom"><img src="/move/bottom.png" alt="Move to the bottom"/></button>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<button type="submit" title="Reload"><img src="/reload.png" alt="Reload"/></button>
</p>

<table class="transfers">
<thead>
<tr><td>Name</td><td class="m">Progress</td><td class="m">Size</td><td class="m">Speed <img src="/download.png" alt="down"/></td><td class="m">Speed <img src="/upload.png" alt="up"/></td><td class="m">Time left</td><td>Message</td></tr>
</thead>

<tbody>
<?
	function stateSuffix(transfer)
	{
		if(transfer.mode == 1)
			return '';
		
		if(transfer.primaryMode == 1)
		{
			if(transfer.state == 'Completed')
				return '';
		}
		
		return '_upload';
	}
	function shorten(text)
	{
		LIMIT = 60;
		text = new String(text);
		if(text.length > LIMIT)
			return text.substring(0, LIMIT-3) + '...';
		else
			return text;
	}
	
	if(GET.queue == undefined)
	{
		print("No queue");
		return;
	}
	
	var queue = QUEUES[GET.queue];
	if(POST.queueLimits != undefined)
		queue.setSpeedLimits(POST.downLimit*1024, POST.upLimit*1024);
	if(POST.setState && POST.transfer)
	{
		for(i=queue.size-1;i>=0;i--)
		{
			if(!POST.transfer[i])
				continue;

			if(POST.setState == 'Active')
			{
				if(!queue.at(i).active)
				{
					queue.at(i).state = 'Waiting';
					continue;
				}
			}
			queue.at(i).state = POST.setState;
		}
	}
	if(POST.remove && POST.transfer)
	{
		for(i=queue.size-1;i>=0;i--)
		{
			if(!POST.transfer[i])
				continue;
			if(POST.remove == 'delete_data')
				queue.removeWithData(i, true);
			else
				queue.remove(i, true);
		}
	}
	if(POST.cleanup)
	{
		for(i=queue.size-1;i>=0;i--)
		{
			if(queue.at(i).state == 'Completed')
				queue.remove(i, true);
		}
	}
	if(POST.move && POST.transfer)
	{
		if(POST.move == 'top')
		{
			var x = 0;
			for(i=queue.size-1;i>=0;i--)
			{
				if(POST.transfer[i])
					queue.moveToTop(i+x++);
			}
		}
		else if(POST.move == 'up')
		{
			for(i=0;i<queue.size;i++)
			{
				if(POST.transfer[i])
					queue.moveUp(i);
			}
		}
		else if(POST.move == 'down')
		{
			for(i=queue.size-1;i>=0;i--)
			{
				if(POST.transfer[i])
					queue.moveDown(i);
			}
		}
		else if(POST.move == 'bottom')
		{
			var x = 0;
			for(i=0;i<queue.size;i++)
			{
				if(POST.transfer[i])
					queue.moveToBottom(i-x++)
			}
		}
	}
	
	for(i=0;i<queue.size;i++)
	{
		var transfer = queue.at(i);
		
		print('<tr id="transfer'+i+'_tr" onclick="javascript:clickedTransfer(event,'+i+')"><td><span class="ralign">');
		var info = fileInfo(transfer.dataPath);
		if(info)
		{
			if(info.directory)
			{
				print(' <a href="/browse.qsp?queue='+GET.queue+'&amp;transfer='+i+'&amp;path=" onclick="javascript: return newwin(this.href);"><img src="/browse.png" alt="Browse" title="Browse"/></a> ');
			}
			else
			{
				print(' <a href="/download?queue='+GET.queue+'&amp;transfer='+i+'&amp;path="><img src="/down.png" alt="Download" title="Download"/></a> ');
			}
		}
		
		print('<a onclick="javascript:return newwin(this.href);" href="/generate/graph.png?'+GET.queue+';'+i+'"><img src="/graph.png" title="Graph" alt="Graph"/></a></span>');
		
		print(' <img src="/states/' + transfer.state.toLowerCase()+stateSuffix(transfer) + '.png" alt="' + transfer.state + '"/> ');
		print(' <input type="checkbox" id="transfer'+i+'" onclick="javascript:checkTransfer(this)" name="transfer['+i+']" value="true"/> ');
		print('<a onclick="javascript:return newwin(this.href);" title="Details" href="/details.qsp?queue='+GET.queue+'&amp;transfer='+i+'">' + shorten(transfer.name) + '</a></td>');
		
		var progress;
		if(transfer.total > 0)
		{
			progress = 100*transfer.done/transfer.total;
			progress = Math.round(progress*10)/10;
			
			print('<td class="m"><img src="/generate/progress.png?'+progress+'%25" alt="'+progress+'%"/></td>');
			print('<td class="m">'+formatSize(transfer.total, false)+'</td>');
		}
		else
		{
			print('<td class="m"><img src="/generate/progress.png?%3F" alt="?"/></td><td class="m">?</td>');
		}
		
		speed = transfer.speed();
		text = '';
		if(speed.down > 0)
			text = formatSize(speed.down, true);
		print('<td class="m">'+text+'</td>');
		text = '';
		
		if(speed.up > 0)
			text = formatSize(speed.up, true);
		print('<td class="m">'+text+'</td>');
		
		print('<td class="m">'+transfer.timeLeft()+'</td>'); // time left
		print('<td>'+transfer.message+'</td></tr>');
	}
?>

</tbody>
</table>
</form>

<form method="post" action="?<? print(escapeAmpersand(QUERY_STRING)); ?>">

<?
	var sl = null;
	if(queue != undefined)
		sl = queue.speedLimits();
?>

<p>
	<span class="ralign">Queue speed limit:
		<span class="speedspan"><input type="text" size="4" name="downLimit" value="<? if(sl) print(sl.down/1024); ?>"/> kB/s down</span>
		<span class="speedspan"><input type="text" size="4" name="upLimit" value="<? if(sl) print(sl.up/1024); ?>"/> kB/s up</span>
		<input type="submit" name="queueLimits" value="Set"/>
	</span>
	<input type="button" value="Check all" onclick="javascript: checkAll(true);"/>
	<input type="button" value="Uncheck all" onclick="javascript: checkAll(false);"/>
</p>
</form>

<hr/>

<p style="text-align: center; font-size: x-small"><b><a href="http://fatrat.dolezel.info">FatRat</a></b> is Copyright © 2006-2008 Luboš Doležel</p>

</body>
</html>
