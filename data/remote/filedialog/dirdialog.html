<!DOCTYPE html
PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>FatRat - choose a directory</title>
<link rel="icon" href="/favicon.png" type="image/png"/>
<link rel="stylesheet" type="text/css" href="/style.css"/>

<script type="text/javascript"><!--

function Directory(where, name)
{
	this.parent = document.getElementById(where);
	if(!this.parent)
		alert("Parent not found");
	this.div = document.createElement("div");
	this.div.className = "treeNode";
	
	if(where != "tree")
		this.div.id = where+name+"/";
	else
		this.div.id = name;
	
	this.img = document.createElement("img");
	this.img.src = "plus.png";
	
	this.a = document.createElement("a");
	this.a.href = "javascript:";
	
	this.span = document.createElement("span");
	textNode = document.createTextNode(name);
	this.span.appendChild(textNode);
	this.a.appendChild(this.span);
	
	this.div.appendChild(this.img);
	this.div.appendChild(this.a);
	
	this.parent.appendChild(this.div);
	
	addEventListener(this.img, "click", "clicked", this);
	addEventListener(this.span, "click", "dirClicked", this);
}

Directory.prototype =
{
	expanded: false,
	clicked: function()
	{
		if(this.expanded)
			this.collapse();
		else
			this.expand();
	},
	expand: function()
	{
		this.img.src = "minus.png";
		this.expanded = true;
		
		var request = new XMLHttpRequest();
		var onExpand = this.onExpand, thisdiv = this.div;
		
		if(request.overrideMimeType)
			request.overrideMimeType('text/xml');
		
		request.open("GET", "ajaxrequest.qsp?path="+this.div.id.replace("&","%26")+"&dirsOnly=true", true);
		request.onreadystatechange = function()
		{
			if(request.readyState == 4 && request.status == 200)
			{
				var dirs = request.responseXML.documentElement.getElementsByTagName('dir');
				var subdirs = new Object();
				
				for(i=0;i<dirs.length;i++)
				{
					var name = dirs[i].attributes.getNamedItem('name').value;
					var s = new Directory(thisdiv.id, name);
					subdirs[name] = s;
				}
				scrollToElem(thisdiv);
				if(onExpand)
					onExpand(subdirs);
			}
		}
		request.send(null);
	},
	
	collapse: function()
	{
		this.img.src = "plus.png";
		this.expanded = false;
		var divs = this.div.getElementsByTagName('div');
		
		for(var i=this.div.childNodes.length-1;i>=0;i--)
		{
			var node = this.div.childNodes[i];
			if(node.tagName.toLowerCase() != 'div')
				continue;
			this.div.removeChild(node);
		}
	},
	
	dirClicked: function()
	{
		window.opener.doneDirDialog(this.div.id);
		window.close();
	},

	onExpand: null
};

function addEventListener(element, type, func, obj)
{
	var handler, params = new Array();
	if(typeof(func) == "function")
	{
		for (var i = 3; i < arguments.length; i++)
			params.push(arguments[i]);

		handler = function (event)
		{
			var p = new Array(event).concat(params);
			var result = func.apply(null, p);
			if(result == false)
			{
				event.returnValue = false;
				if(event.preventDefault)
					event.preventDefault();
			}
			return result;
		}
	}
	else
	{
		for(var i = 4; i < arguments.length; i++)
			params.push(arguments[i]);
		
		handler = function (event)
		{
			var p = new Array(event).concat(params);
			var result = obj[func].apply(obj, p);
			if(result == false)
			{
				event.returnValue = false;
				if(event.preventDefault)
					event.preventDefault();
			}
			return result;
		}
	}
	element.addEventListener(type, handler, false);
	return handler;
}

var dirs, destElem;

function init()
{
	var root = new Directory("tree", "/");
	
	var qmark = document.URL.indexOf('?');
	if(qmark != -1)
		dirs = document.URL.substring(qmark+1).split("/");
	
	root.onExpand = expandDir;
	root.expand();
}

function setDestElem(elem)
{
	destElem = elem;
}

function expandDir(subdirs)
{
	if(!dirs)
		return;
	
	while(dirs.length > 0)
	{
		var name = dirs.shift();
		if(name.length == 0)
			continue;
		var subd = subdirs[name];
		if(subd)
		{
			subd.onExpand = expandDir;
			subd.expand();
			return;
		}
	}
}

function scrollToElem(elem)
{
	var y = 0;
	while(elem)
	{
		y += elem.offsetTop;
		elem = elem.offsetParent;
	}

	window.scrollTo(0, y);
}

//--></script>
</head>
<body onload="javascript:init()">

<p style="text-align: center"><b>Choose a directory</b></p>

<div class="tree" id="tree">
</div>

</body></html>
